<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Baby Reveal — Boy or Girl</title>
    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;600&display=swap"
      rel="stylesheet"
    />
    <style>
      :root {
        --gold: #d4af37;
        --cream: #fff9f0;
        --rose: #ff9cb2;
        --royal: #6ea8ff;
        --bg1: #fffaf4;
        --bg2: #f1e5c7;
        --text: #3a2f1e;
        --muted: #8c7b60;
        --card-bg: rgba(255, 255, 255, 0.66);
        --radius: 20px;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
      }
      body {
        margin: 0;
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        background: linear-gradient(180deg, var(--bg1) 0%, var(--bg2) 100%);
        color: var(--text);
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 28px;
      }
      .wrap {
        width: 100%;
        max-width: 960px;
      }
      .card {
        background: var(--card-bg);
        border-radius: calc(var(--radius)+6px);
        border: 1px solid rgba(212, 175, 55, 0.24);
        box-shadow: 0 24px 70px rgba(180, 145, 45, 0.2);
        padding: 26px;
        position: relative;
        overflow: hidden;
        backdrop-filter: blur(10px);
      }

      /* Header + shimmer */
      .header {
        text-align: center;
        margin-bottom: 10px;
        padding: 6px 0;
        position: relative;
      }
      .crest {
        font-family: "Playfair Display", serif;
        font-size: 40px;
        color: var(--text);
      }
      .title {
        font-family: "Playfair Display", serif;
        font-size: 30px;
        margin: 6px 0;
        color: var(--text);
        display: inline-block;
        position: relative;
        padding: 6px 14px;
        border-radius: 12px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.35),
          rgba(255, 255, 255, 0.1)
        );
        border: 1px solid rgba(212, 175, 55, 0.18);
      }
      .title::before {
        content: "";
        position: absolute;
        left: -60%;
        top: 0;
        width: 40%;
        height: 100%;
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0),
          rgba(255, 255, 255, 0.6),
          rgba(255, 255, 255, 0)
        );
        transform: skewX(-20deg);
        animation: shimmer 3.8s linear infinite;
        border-radius: 12px;
        mix-blend-mode: overlay;
      }
      @keyframes shimmer {
        0% {
          left: -60%;
        }
        50% {
          left: 120%;
        }
        100% {
          left: 120%;
        }
      }
      .sub {
        color: var(--muted);
        margin: 4px 0 10px;
        font-size: 14px;
      }

      /* countdown under title */
      .headerCount {
        display: flex;
        justify-content: center;
        gap: 10px;
        margin: 12px 0 10px;
      }
      .countCard {
        background: rgba(255, 255, 255, 0.85);
        border-radius: 10px;
        padding: 8px 12px;
        border: 1px solid rgba(212, 175, 55, 0.12);
        min-width: 70px;
        text-align: center;
        font-weight: 800;
        color: var(--text);
      }
      .countLabel {
        font-size: 12px;
        color: var(--muted);
        font-weight: 600;
        margin-top: 4px;
      }

      /* teams */
      .teams {
        display: flex;
        gap: 18px;
        justify-content: center;
        margin-bottom: 18px;
      }
      .team-pill {
        display: flex;
        align-items: center;
        gap: 10px;
        padding: 10px 18px;
        border-radius: 12px;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.68),
          rgba(255, 255, 255, 0.56)
        );
        border: 1px solid rgba(212, 175, 55, 0.16);
        box-shadow: 0 6px 20px rgba(212, 175, 55, 0.06);
        min-width: 160px;
        justify-content: center;
      }
      .team-pill .label {
        font-weight: 700;
        color: var(--muted);
        margin-right: 8px;
      }
      .team-pill .count {
        font-family: "Playfair Display", serif;
        font-weight: 700;
        color: var(--gold);
        font-size: 18px;
      }

      .grid {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 22px;
        align-items: start;
      }
      @media (max-width: 880px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .team-pill {
          min-width: auto;
        }
      }

      .choices {
        display: flex;
        flex-direction: column;
        gap: 14px;
      }
      .choice {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.74),
          rgba(255, 255, 255, 0.64)
        );
        border-radius: 14px;
        padding: 18px;
        border: 1px solid rgba(212, 175, 55, 0.14);
        display: flex;
        align-items: center;
        gap: 16px;
        cursor: pointer;
        position: relative;
        transition: transform 0.16s ease, box-shadow 0.16s ease;
      }
      .choice:hover {
        transform: translateY(-6px);
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.08);
      }
      .choice.selected {
        transform: translateY(-12px);
        box-shadow: 0 24px 56px rgba(0, 0, 0, 0.12);
        border-color: rgba(212, 175, 55, 0.28);
      }
      .emoji {
        font-size: 44px;
        width: 64px;
        text-align: center;
      }
      .meta {
        display: flex;
        flex-direction: column;
      }
      .titleSmall {
        font-family: "Playfair Display", serif;
        font-weight: 700;
        font-size: 20px;
        margin-bottom: 4px;
      }
      .desc {
        color: var(--muted);
        font-size: 13px;
      }
      .choice::after {
        content: "";
        position: absolute;
        right: 12px;
        top: 12px;
        width: 40px;
        height: 40px;
        border-radius: 10px;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        font-size: 16px;
      }
      .choice.selected::after {
        display: flex;
      }
      .choice#boy.selected::after {
        background: linear-gradient(135deg, #f9e6b0, #f3d67a);
        color: #3a2f1e;
        content: "✔";
      }
      .choice#girl.selected::after {
        background: linear-gradient(135deg, #ffdbe6, #ffc0d1);
        color: #3a2f1e;
        content: "✔";
      }

      .panel {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.72),
          rgba(255, 255, 255, 0.64)
        );
        border-radius: 14px;
        padding: 16px;
        border: 1px solid rgba(212, 175, 55, 0.14);
      }
      .panel h3 {
        margin: 0 0 8px;
        font-family: "Playfair Display", serif;
      }
      .panel .muted {
        color: var(--muted);
        font-size: 13px;
        margin-bottom: 10px;
      }
      .inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-bottom: 10px;
      }
      .inputs input {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(212, 175, 55, 0.12);
        background: transparent;
      }
      .cta {
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .btnMain {
        background: linear-gradient(90deg, #f9e6b0, #f3d67a);
        border: 0;
        padding: 12px 14px;
        border-radius: 10px;
        font-weight: 800;
        cursor: pointer;
        color: #3a2f1e;
      }
      .btnGhost {
        background: transparent;
        border: 1px dashed rgba(212, 175, 55, 0.18);
        padding: 10px 12px;
        border-radius: 10px;
        cursor: pointer;
        color: var(--muted);
      }

      footer {
        text-align: center;
        color: var(--muted);
        margin-top: 16px;
        font-size: 13px;
      }

      /* modal + sparkles */
      .modalWrap {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(10, 10, 10, 0.4);
        z-index: 999;
      }
      .modal {
        background: white;
        padding: 18px;
        border-radius: 12px;
        max-width: 420px;
        width: 92%;
        box-shadow: 0 20px 60px rgba(0, 0, 0, 0.35);
        text-align: center;
        position: relative;
        overflow: visible;
      }
      .modal h2 {
        margin: 0 0 8px;
        font-family: "Playfair Display", serif;
        color: #2b1f14;
      }
      .modal p {
        color: #5b4b3a;
        margin: 8px 0 12px;
      }
      .modal .sparkles {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: visible;
        z-index: 2;
      }
      .modal .sparkles .spark {
        position: absolute;
        width: 8px;
        height: 8px;
        border-radius: 50%;
        background: linear-gradient(180deg, #fff9da, #ffd37a);
        box-shadow: 0 0 8px rgba(212, 175, 55, 0.9),
          0 0 18px rgba(212, 175, 55, 0.35);
        opacity: 0;
        transform: scale(0.2) translateY(0);
        animation: sparkle-pop 900ms cubic-bezier(0.2, 0.9, 0.3, 1) forwards;
      }
      .modal .sparkles .spark.pink {
        background: linear-gradient(180deg, #fff0f8, #ffbed8);
        box-shadow: 0 0 8px rgba(255, 156, 178, 0.9),
          0 0 18px rgba(255, 156, 178, 0.28);
      }
      @keyframes sparkle-pop {
        0% {
          opacity: 0;
          transform: scale(0.2) translateY(6px);
        }
        20% {
          opacity: 1;
          transform: scale(1.05) translateY(-2px);
        }
        60% {
          opacity: 1;
          transform: scale(0.9) translateY(-8px);
        }
        100% {
          opacity: 0;
          transform: scale(0.6) translateY(-20px);
        }
      }
      .modal .msg-shimmer {
        display: block;
        position: absolute;
        left: -8%;
        top: -14%;
        width: 120%;
        height: 40%;
        background: radial-gradient(
          ellipse at center,
          rgba(212, 175, 55, 0.18) 0%,
          rgba(212, 175, 55, 0.06) 40%,
          rgba(0, 0, 0, 0) 60%
        );
        filter: blur(6px);
        transform: rotate(-4deg);
        pointer-events: none;
        z-index: 1;
        border-radius: 12px;
      }
      .modal .modal-content-inner {
        position: relative;
        z-index: 3;
      }

      #confetti {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 10;
      }

      @media (max-width: 880px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .teams {
          flex-direction: column;
          gap: 8px;
        }
        .team-pill {
          min-width: auto;
        }
      }
    </style>
  </head>
  <body>
    <div class="wrap">
      <div class="card" id="card">
        <canvas id="confetti"></canvas>

        <div class="header">
          <div class="crest">👑</div>
          <div class="title">Baby Reveal</div>
          <p class="sub">
            Aman & Akanksha invite you — predict whether it will be a prince or
            princess
          </p>

          <div class="headerCount" aria-hidden="false">
            <div class="countCard">
              <div id="cdDays">0</div>
              <div class="countLabel">Days</div>
            </div>
            <div class="countCard">
              <div id="cdHours">0</div>
              <div class="countLabel">Hours</div>
            </div>
            <div class="countCard">
              <div id="cdMins">0</div>
              <div class="countLabel">Mins</div>
            </div>
            <div class="countCard">
              <div id="cdSecs">0</div>
              <div class="countLabel">Secs</div>
            </div>
          </div>
        </div>

        <div class="teams">
          <div class="team-pill">
            <span class="label">Boy Votes</span
            ><span class="count" id="boyCount">0</span>
          </div>
          <div class="team-pill">
            <span class="label">Girl Votes</span
            ><span class="count" id="girlCount">0</span>
          </div>
        </div>

        <div class="grid">
          <div class="choices">
            <div
              class="choice"
              id="boy"
              data-value="boy"
              role="button"
              tabindex="0"
              aria-pressed="false"
            >
              <div class="emoji">🤴💙</div>
              <div class="meta">
                <div class="titleSmall">It's a Boy!</div>
                <div class="desc">Choose if you predict a little prince</div>
              </div>
            </div>

            <div
              class="choice"
              id="girl"
              data-value="girl"
              role="button"
              tabindex="0"
              aria-pressed="false"
            >
              <div class="emoji">👸💖</div>
              <div class="meta">
                <div class="titleSmall">It's a Girl!</div>
                <div class="desc">Choose if you predict a little princess</div>
              </div>
            </div>
          </div>

          <div class="panel">
            <h3>Make your prediction</h3>
            <div class="muted">
              Reveal Date: <strong>14 November 2025</strong>
            </div>

            <div class="inputs" style="margin-top: 12px">
              <input id="name" placeholder="Your Name (optional)" />
              <input
                id="relation"
                placeholder="Relation (e.g., Masi, Chachu)"
              />
            </div>

            <div class="cta" style="margin-top: 6px">
              <button class="btnMain" id="voteBtn">
                Submit Your Prediction
              </button>
              <button class="btnGhost" id="shareBtn">Share</button>
            </div>

            <div style="margin-top: 12px; font-size: 13px; color: var(--muted)">
              Tip: Enter your name to get a personalized thank-you after voting.
            </div>
          </div>
        </div>

        <footer>With love, Aman & Akanksha</footer>
      </div>
    </div>

    <!-- Thank you modal -->
    <div
      class="modalWrap"
      id="modalWrap"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
    >
      <div
        class="modal"
        role="document"
        aria-labelledby="modalTitle"
        aria-describedby="modalMsg"
      >
        <h2 id="modalTitle">Thank you!</h2>
        <div id="modalMsg" class="modal-content">
          <p>We appreciate your prediction.</p>
        </div>
        <button class="btnMain" id="modalClose">Close</button>
      </div>
    </div>

    <!-- Firebase + logic -->
    <script type="module">
      // ---------- CONFIG ----------
      const FORMSPREE_ENDPOINT = "https://formspree.io/f/xzzkjneo";

      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        get,
      } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

      const firebaseConfig = {
        apiKey: "AIzaSyDJMam9PYVpprTjX-hSx4zqoqkp5AOEQaA",
        authDomain: "baby-prediction-2947c.firebaseapp.com",
        databaseURL:
          "https://baby-prediction-2947c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "baby-prediction-2947c",
        storageBucket: "baby-prediction-2947c.firebasestorage.app",
        messagingSenderId: "746431850655",
        appId: "1:746431850655:web:2d3d4cddf4e7fa6e855aaa",
        measurementId: "G-Y4LQT2ZRD5",
      };

      // ---------- INIT ----------
      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);

      // ---------- UI refs ----------
      const choices = Array.from(document.querySelectorAll(".choice"));
      const boyCountEl = document.getElementById("boyCount");
      const girlCountEl = document.getElementById("girlCount");
      const voteBtn = document.getElementById("voteBtn");
      const shareBtn = document.getElementById("shareBtn");
      const nameInput = document.getElementById("name");
      const relInput = document.getElementById("relation");
      const modalWrap = document.getElementById("modalWrap");
      const modalTitle = document.getElementById("modalTitle");
      const modalMsg = document.getElementById("modalMsg");
      const modalClose = document.getElementById("modalClose");

      const cdDays = document.getElementById("cdDays");
      const cdHours = document.getElementById("cdHours");
      const cdMins = document.getElementById("cdMins");
      const cdSecs = document.getElementById("cdSecs");

      const revealDate = new Date("2025-11-14T00:00:00");

      let myUid = null;
      let selectedValue = null;
      let authReady = false;

      // ---------- Auth + realtime listener ----------
      function disableVoteUI() {
        if (voteBtn) {
          voteBtn.disabled = true;
          voteBtn.style.opacity = 0.6;
        }
      }
      function enableVoteUI() {
        if (voteBtn) {
          voteBtn.disabled = false;
          voteBtn.style.opacity = 1;
        }
      }
      disableVoteUI();

      async function startAuth() {
        try {
          await signInAnonymously(auth);
          console.log("Anonymous sign-in requested");
        } catch (e) {
          console.error("startAuth error", e);
        }
      }

      function attachRealtimeListener() {
        if (window._votesListenerAttached) return;
        window._votesListenerAttached = true;
        const votesRef = ref(db, "votes");
        onValue(
          votesRef,
          (snap) => {
            const data = snap.val() || {};
            let boy = 0,
              girl = 0;
            for (const uid in data) {
              const v = data[uid] && data[uid].vote;
              if (v === "boy") boy++;
              if (v === "girl") girl++;
            }
            if (boyCountEl) boyCountEl.textContent = boy;
            if (girlCountEl) girlCountEl.textContent = girl;
            // reflect my vote
            if (myUid && data[myUid]) {
              selectedValue = data[myUid].vote;
              choices.forEach((c) =>
                c.classList.toggle(
                  "selected",
                  c.dataset.value === selectedValue
                )
              );
            }
          },
          (err) => {
            console.error("Realtime listener error", err);
          }
        );
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          myUid = user.uid;
          authReady = true;
          console.log("Signed in anonymously as", myUid);
          attachRealtimeListener();
          enableVoteUI();
        } else {
          myUid = null;
          authReady = false;
          disableVoteUI();
          startAuth();
        }
      });
      startAuth();

      // ---------- confetti (self-contained) ----------
      const confCanvas = document.getElementById("confetti");
      const ctx = confCanvas.getContext && confCanvas.getContext("2d");
      let confettiParticles = [],
        confAnim = false;
      function resizeCanvas() {
        if (!ctx) return;
        confCanvas.width = confCanvas.clientWidth;
        confCanvas.height = confCanvas.clientHeight;
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      function launchConfetti() {
        if (!ctx) return;
        for (let i = 0; i < 60; i++) {
          confettiParticles.push({
            x: Math.random() * confCanvas.width,
            y: -Math.random() * confCanvas.height * 0.5,
            w: 6 + Math.random() * 10,
            h: 8 + Math.random() * 10,
            vx: (Math.random() - 0.5) * 4,
            vy: 2 + Math.random() * 4,
            rot: Math.random() * 360,
            vr: (Math.random() - 0.5) * 8,
            color: ["#d4af37", "#f9e6b0", "#ffd37a"][
              Math.floor(Math.random() * 3)
            ],
          });
        }
        if (!confAnim) animateConfetti();
      }
      function animateConfetti() {
        confAnim = true;
        ctx.clearRect(0, 0, confCanvas.width, confCanvas.height);
        for (let i = confettiParticles.length - 1; i >= 0; i--) {
          const p = confettiParticles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.06;
          p.rot += p.vr;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate((p.rot * Math.PI) / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          ctx.restore();
          if (p.y > confCanvas.height + 50) confettiParticles.splice(i, 1);
        }
        if (confettiParticles.length) requestAnimationFrame(animateConfetti);
        else {
          confAnim = false;
          ctx.clearRect(0, 0, confCanvas.width, confCanvas.height);
        }
      }

      // ---------- sparkles + modal helpers (top-level) ----------
      function createSparkles(count = 8, duration = 900) {
        let container = modalWrap.querySelector(".sparkles");
        if (!container) {
          container = document.createElement("div");
          container.className = "sparkles";
          const modalEl = modalWrap.querySelector(".modal");
          if (modalEl) modalEl.appendChild(container);
        }
        for (let i = 0; i < count; i++) {
          const s = document.createElement("span");
          s.className = "spark" + (Math.random() > 0.5 ? " pink" : "");
          const left = 12 + Math.random() * 76;
          const top = 22 + Math.random() * 56;
          s.style.left = left + "%";
          s.style.top = top + "%";
          const delay = Math.random() * 220;
          s.style.animationDelay = delay + "ms";
          container.appendChild(s);
          setTimeout(() => {
            if (s && s.parentNode) s.parentNode.removeChild(s);
          }, duration + delay + 60);
        }
        setTimeout(() => {
          const cur = modalWrap.querySelector(".sparkles");
          if (cur && cur.childElementCount === 0)
            cur.parentNode && cur.parentNode.removeChild(cur);
        }, duration + 500);
      }

      function openModalContent(htmlTitle, htmlMessage) {
        modalTitle.textContent = htmlTitle;
        modalMsg.innerHTML = htmlMessage;
        modalWrap.setAttribute("aria-hidden", "false");
        modalWrap.style.display = "flex";
        // focus close button (small delay for screenreaders)
        setTimeout(() => {
          modalClose.focus();
        }, 30);
      }
      function closeModalSafe() {
        if (document.activeElement) document.activeElement.blur();
        modalWrap.style.display = "none";
        modalWrap.setAttribute("aria-hidden", "true");
      }

      // ---------- thank you UI (top-level) ----------
      function showThankYou(nameOrWho, vote) {
        // Gather name + relation
        const nm = (nameInput?.value || "").trim();
        const rel = (relInput?.value || "").trim();

        // Build display name
        let displayName = "Friend";
        if (nm && rel) displayName = `${nm} (${rel})`;
        else if (nm) displayName = nm;
        else if (rel) displayName = rel;

        // Select heart color by prediction 💙💖
        const heartEmoji = vote === "boy" ? "💙" : "💖";

        // Random sweet messages
        const sweetLines = [
          "Your blessings mean the world to us — thank you for being part of our joy!",
          "Your good wishes wrap this little one in love already.",
          "We can feel the love — thank you for celebrating with us!",
          "Your kind prediction brings a smile to our hearts — thank you!",
          "Thank you for the warm wishes — we can’t wait to share the joy with you.",
          "Your excitement makes this moment even more magical — thank you!",
        ];

        // Boy/Girl-specific line
        const voteLine =
          vote === "boy"
            ? "You believe a little <strong>Prince 🤴</strong> is on his way — may his laughter fill our home with joy!"
            : "You believe a little <strong>Princess 👸</strong> is coming — may her smile bring endless sunshine!";

        // Pick a random sweet line
        const randomLine =
          sweetLines[Math.floor(Math.random() * sweetLines.length)];

        // Set the modal title with colored heart 💙 or 💖
        modalTitle.textContent = `Thank you, ${displayName} ${heartEmoji}`;

        // Compose message body
        modalMsg.innerHTML = `
    <span class="msg-shimmer" aria-hidden="true"></span>
    <div class="modal-content-inner">
      <div style="margin-bottom:8px; font-weight:600; color:#2b1f14;">
        ${randomLine}
      </div>
      <div style="font-size:14px; color:#5b4b3a;">
        ${voteLine}
      </div>
    </div>
  `;

        // Show modal
        modalWrap.setAttribute("aria-hidden", "false");
        modalWrap.style.display = "flex";
        setTimeout(() => modalClose.focus(), 40);

        // Sparkles & confetti
        createSparkles(10, 900);
        if (typeof launchConfetti === "function") launchConfetti();

        // Auto-close
        setTimeout(() => {
          if (document.activeElement) document.activeElement.blur();
          modalWrap.style.display = "none";
          modalWrap.setAttribute("aria-hidden", "true");
        }, 5500);
      }
      // ---------- voting logic ----------
      function setVoteButtonState(isWorking) {
        if (!voteBtn) return;
        voteBtn.disabled = !!isWorking;
        voteBtn.style.opacity = isWorking ? 0.6 : 1;
        voteBtn.textContent = isWorking
          ? "Submitting..."
          : "Submit Your Prediction";
      }

      async function submitVote(voteValue) {
        if (!authReady || !myUid) {
          alert("Still signing in. Please wait a moment and try again.");
          return;
        }
        setVoteButtonState(true);
        // read previous
        let previousVote = "";
        try {
          const snap = await get(ref(db, `votes/${myUid}`));
          if (snap.exists()) {
            const prev = snap.val();
            previousVote = prev && prev.vote ? prev.vote : "";
          }
        } catch (e) {
          console.warn("read prev err", e);
        }
        const payload = {
          vote: voteValue,
          name: (nameInput.value || "").trim(),
          relation: (relInput.value || "").trim(),
          time: new Date().toISOString(),
        };
        try {
          await set(ref(db, `votes/${myUid}`), payload);
          console.log("Vote written to Firebase", payload);
        } catch (e) {
          console.error("Firebase write failed", e);
          alert("Could not save vote. Please check your connection.");
          setVoteButtonState(false);
          return;
        }
        // send to Formspree (best-effort)
        try {
          const body = {
            event: "vote",
            previous_vote: previousVote || "",
            new_vote: voteValue,
            name: payload.name,
            relation: payload.relation,
            time: payload.time,
          };
          fetch(FORMSPREE_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          })
            .then((r) => console.log("Formspree status", r.status))
            .catch((e) => console.warn("Formspree failed", e));
        } catch (e) {
          console.warn("Formspree error", e);
        }
        setVoteButtonState(false);
      }

      // UI selection
      choices.forEach((c) => {
        c.addEventListener("click", () => {
          choices.forEach((x) => x.classList.remove("selected"));
          c.classList.add("selected");
          selectedValue = c.dataset.value;
        });
        c.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            c.click();
          }
        });
      });

      voteBtn.addEventListener("click", async () => {
        if (!selectedValue) {
          alert("Please select Boy or Girl.");
          return;
        }
        await submitVote(selectedValue);
        const nm = (nameInput.value || "").trim(),
          rel = (relInput.value || "").trim();
        const who = nm
          ? `${nm}${rel ? " (" + rel + ")" : ""}`
          : rel
          ? rel
          : "Friend";
        showThankYou(who, selectedValue);
      });

      // share
      shareBtn.addEventListener("click", () => {
        const txt = encodeURIComponent(
          `Join Aman & Akanksha’s Royal Baby Reveal — Cast your prediction: ${location.href}`
        );
        if (navigator.share)
          navigator
            .share({
              title: "Royal Baby Reveal",
              text: "Make your prediction!",
              url: location.href,
            })
            .catch(() => {});
        else window.open("https://wa.me/?text=" + txt, "_blank");
      });

      // modal close handlers
      modalClose.addEventListener("click", () => closeModalSafe());
      modalWrap.addEventListener("click", (e) => {
        if (e.target === modalWrap) closeModalSafe();
      });

      // countdown
      function updateCountdown() {
        const now = new Date();
        const diff = revealDate.getTime() - now.getTime();
        if (diff <= 0) {
          cdDays.textContent = "0";
          cdHours.textContent = "0";
          cdMins.textContent = "0";
          cdSecs.textContent = "0";
          return;
        }
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);
        cdDays.textContent = days;
        cdHours.textContent = hours;
        cdMins.textContent = mins;
        cdSecs.textContent = secs;
      }
      updateCountdown();
      setInterval(updateCountdown, 1000);

      // keyboard nav for choices
      choices.forEach((c, i) =>
        c.addEventListener("keydown", (e) => {
          if (e.key === "ArrowDown" || e.key === "ArrowRight")
            choices[(i + 1) % choices.length].focus();
          if (e.key === "ArrowUp" || e.key === "ArrowLeft")
            choices[(i - 1 + choices.length) % choices.length].focus();
        })
      );

      console.log("Script initialized, waiting for auth...");
    </script>
  </body>
</html>
