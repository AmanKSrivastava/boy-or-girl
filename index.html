<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>
      Welcome Little One ‚Äî Cast Your Vote ‚Äî Baby Boy Gang vs Baby Girl Gang
    </title>

    <link
      href="https://fonts.googleapis.com/css2?family=Playfair+Display:wght@500;700&family=Inter:wght@400;600;700&display=swap"
      rel="stylesheet"
    />

    <style>
      :root {
        --bg-1: #fffaf4;
        --bg-2: #f3e7c8;
        --card: rgba(255, 255, 255, 0.92);
        --muted: #7d6a50;
        --gold: #d4af37;
        --boy-1: #2f6ff7;
        --boy-2: #89b8ff;
        --girl-1: #ff4da6;
        --girl-2: #ffb0d6;
        --radius: 16px;
        --glass-border: rgba(212, 175, 55, 0.12);
        --accent-shadow: 0 18px 60px rgba(160, 120, 30, 0.08);
        --toast-success: #1f7a3a;
        --toast-error: #9b2b2b;
        --toast-info: #265a8a;
      }
      * {
        box-sizing: border-box;
      }
      html,
      body {
        height: 100%;
        margin: 0;
      }
      body {
        font-family: "Inter", system-ui, -apple-system, "Segoe UI", Roboto,
          "Helvetica Neue", Arial;
        background: radial-gradient(
            1200px 600px at 10% 10%,
            rgba(212, 175, 55, 0.06),
            transparent 8%
          ),
          linear-gradient(180deg, var(--bg-1), var(--bg-2));
        color: #231a10;
        display: flex;
        align-items: center;
        justify-content: center;
        padding: 18px;
      }

      .wrap {
        width: 100%;
        max-width: 1100px;
        animation: fadeInUp 0.4s ease both;
      }
      @keyframes fadeInUp {
        from {
          opacity: 0;
          transform: translateY(8px);
        }
        to {
          opacity: 1;
          transform: none;
        }
      }

      .card {
        background: var(--card);
        border-radius: calc(var(--radius)+10px);
        padding: 18px;
        border: 1px solid var(--glass-border);
        box-shadow: var(--accent-shadow);
        width: 100%;
        overflow: visible;
      }

      /* header */
      .header {
        display: flex;
        align-items: center;
        justify-content: space-between;
        gap: 12px;
        flex-wrap: wrap;
      }
      .brand {
        display: flex;
        align-items: center;
        gap: 12px;
      }
      .crest {
        width: 64px;
        height: 64px;
        border-radius: 12px;
        display: flex;
        align-items: center;
        justify-content: center;
        font-size: 34px;
        background: linear-gradient(180deg, #fffaf0, #fff3d6);
        border: 1px solid rgba(212, 175, 55, 0.12);
      }
      .brand-text .title {
        font-family: "Playfair Display", serif;
        font-size: 20px;
        margin: 0;
        line-height: 1.05;
      }
      .brand-text .subtitle {
        color: var(--muted);
        font-size: 13px;
        margin-top: 6px;
        opacity: 0.95;
      }

      /* right controls - countdown + latest supporter */
      .controls-right {
        display: flex;
        gap: 10px;
        align-items: center;
        flex-wrap: wrap;
      }
      .countdownTop {
        display: flex;
        gap: 8px;
        align-items: center;
        flex-wrap: wrap;
      }
      .count-pill {
        background: rgba(255, 255, 255, 0.96);
        padding: 8px 10px;
        border-radius: 10px;
        border: 1px solid rgba(0, 0, 0, 0.04);
        min-width: 56px;
        text-align: center;
      }
      .count-pill .num {
        font-weight: 800;
        font-size: 15px;
      }
      .count-pill .label {
        font-size: 11px;
        color: var(--muted);
      }

      .latest-supporter {
        background: linear-gradient(
          90deg,
          rgba(255, 255, 255, 0.98),
          rgba(255, 255, 255, 0.95)
        );
        padding: 8px 12px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.04);
        font-size: 13px;
        color: var(--muted);
        display: flex;
        gap: 8px;
        align-items: center;
        min-width: 180px;
        justify-content: center;
      }

      /* teams row */
      .teams-row {
        display: flex;
        gap: 14px;
        margin-top: 14px;
      }
      .team-card {
        flex: 1;
        border-radius: 12px;
        padding: 14px;
        display: flex;
        flex-direction: column;
        align-items: center;
        justify-content: center;
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.98),
          rgba(255, 255, 255, 0.95)
        );
        border: 1px solid rgba(0, 0, 0, 0.04);
        transition: transform 0.28s, box-shadow 0.28s, border-color 0.28s;
      }
      .team-card.leader {
        transform: translateY(-8px);
        box-shadow: 0 30px 60px rgba(0, 0, 0, 0.12);
        border: 2px solid var(--gold);
      }
      .team-name {
        font-weight: 900;
        font-size: 14px;
      }
      .team-score {
        font-family: "Playfair Display", serif;
        font-size: 34px;
        color: var(--gold);
        margin-top: 8px;
      }

      .progress-wrap {
        width: 100%;
        margin-top: 8px;
      }
      .progress-bg {
        background: rgba(0, 0, 0, 0.06);
        height: 12px;
        border-radius: 999px;
        overflow: hidden;
      }
      .progress-fill {
        height: 100%;
        width: 0%;
        border-radius: 999px;
        transition: width 0.8s;
      }
      .team-boy .progress-fill {
        background: linear-gradient(90deg, var(--boy-1), var(--boy-2));
      }
      .team-girl .progress-fill {
        background: linear-gradient(90deg, var(--girl-1), var(--girl-2));
      }
      .percent {
        font-size: 12px;
        color: var(--muted);
        margin-top: 8px;
      }

      /* grid */
      .grid {
        display: grid;
        grid-template-columns: 1fr 380px;
        gap: 18px;
        margin-top: 18px;
      }
      @media (max-width: 980px) {
        .grid {
          grid-template-columns: 1fr;
        }
      }
      @media (max-width: 680px) {
        .grid {
          grid-template-columns: 1fr;
        }
        .brand-text .title {
          font-size: 18px;
        }
        .brand-text .subtitle {
          font-size: 12px;
        }
      }

      /* choices */
      .choices {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }
      .choice {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 14px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.04);
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.98),
          rgba(255, 255, 255, 0.96)
        );
        cursor: pointer;
        position: relative;
        transition: transform 0.18s, box-shadow 0.18s, border-color 0.18s;
      }
      .choice:hover {
        transform: translateY(-6px);
        box-shadow: 0 18px 40px rgba(0, 0, 0, 0.08);
      }
      .choice .emoji {
        font-size: 40px;
        width: 64px;
        height: 56px;
        display: flex;
        align-items: center;
        justify-content: center;
        border-radius: 10px;
      }
      .choice .titleSmall {
        font-family: "Playfair Display", serif;
        font-weight: 800;
        font-size: 18px;
      }
      .choice .desc {
        color: var(--muted);
        font-size: 13px;
        margin-top: 4px;
      }
      .choice.selected {
        transform: translateY(-14px);
        box-shadow: 0 36px 90px rgba(0, 0, 0, 0.12);
        border-color: rgba(212, 175, 55, 0.22);
        z-index: 2;
        animation: choicePulse 0.68s;
      }
      @keyframes choicePulse {
        0% {
          transform: translateY(-8px) scale(1);
        }
        50% {
          transform: translateY(-14px) scale(1.02);
        }
        100% {
          transform: translateY(-14px) scale(1);
        }
      }
      .choice::after {
        content: "";
        position: absolute;
        right: 12px;
        top: 12px;
        width: 46px;
        height: 46px;
        border-radius: 12px;
        display: none;
        align-items: center;
        justify-content: center;
        font-weight: 900;
        font-size: 18px;
        box-shadow: 0 12px 30px rgba(0, 0, 0, 0.12);
      }
      .choice.selected::after {
        display: flex;
      }
      .choice#boy.selected::after {
        background: linear-gradient(135deg, #f9e6b0, #f3d67a);
        color: #3a2f1e;
        content: "‚úî";
      }
      .choice#girl.selected::after {
        background: linear-gradient(135deg, #ffdbe6, #ffc0d1);
        color: #3a2f1e;
        content: "‚úî";
      }

      /* panel */
      .panel {
        background: linear-gradient(
          180deg,
          rgba(255, 255, 255, 0.98),
          rgba(255, 255, 255, 0.96)
        );
        padding: 14px;
        border-radius: 12px;
        border: 1px solid rgba(0, 0, 0, 0.04);
      }
      .panel h3 {
        font-family: "Playfair Display", serif;
        margin: 0 0 6px;
      }
      .inputs {
        display: flex;
        flex-direction: column;
        gap: 10px;
        margin-top: 10px;
      }
      .inputs input {
        padding: 10px;
        border-radius: 10px;
        border: 1px solid rgba(212, 175, 55, 0.1);
        background: transparent;
      }
      .inputs input:focus {
        outline: none;
        box-shadow: 0 10px 30px rgba(212, 175, 55, 0.06);
        transform: translateY(-1px);
      }

      .cta {
        display: flex;
        gap: 10px;
        margin-top: 12px;
        align-items: center;
      }
      .btnMain {
        background: linear-gradient(90deg, #ffd37a, #f3d67a);
        border: 0;
        padding: 12px 14px;
        border-radius: 10px;
        font-weight: 900;
        cursor: pointer;
        box-shadow: 0 10px 30px rgba(212, 175, 55, 0.08);
      }
      .btnMain:disabled {
        opacity: 0.55;
        cursor: not-allowed;
        transform: none;
        box-shadow: none;
      }
      .btnGhost {
        background: transparent;
        border: 1px dashed rgba(212, 175, 55, 0.12);
        padding: 10px;
        border-radius: 10px;
        cursor: pointer;
        color: var(--muted);
      }

      footer {
        margin-top: 14px;
        text-align: center;
        color: var(--muted);
        font-size: 13px;
      }

      /* modal */
      .modalWrap {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        display: none;
        align-items: center;
        justify-content: center;
        background: rgba(10, 10, 10, 0.45);
        z-index: 999;
      }
      .modal {
        background: white;
        padding: 18px;
        border-radius: 12px;
        max-width: 520px;
        width: 94%;
        box-shadow: 0 26px 80px rgba(0, 0, 0, 0.45);
        text-align: center;
        position: relative;
        overflow: visible;
      }
      .modal h2 {
        margin: 0 0 8px;
        font-family: "Playfair Display", serif;
        color: #2b1f14;
      }
      .msg-shimmer {
        position: absolute;
        left: -8%;
        top: -14%;
        width: 120%;
        height: 40%;
        background: radial-gradient(
          ellipse at center,
          rgba(212, 175, 55, 0.18) 0%,
          rgba(212, 175, 55, 0.06) 40%,
          transparent 60%
        );
        filter: blur(7px);
        transform: rotate(-4deg);
        pointer-events: none;
        border-radius: 12px;
      }

      /* sparkles */
      .sparkles {
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        overflow: visible;
        z-index: 2;
      }
      .sparkles .spark {
        position: absolute;
        width: 9px;
        height: 9px;
        border-radius: 50%;
        background: linear-gradient(180deg, #fff9da, #ffd37a);
        box-shadow: 0 0 8px rgba(212, 175, 55, 0.9),
          0 0 18px rgba(212, 175, 55, 0.35);
        opacity: 0;
        transform: scale(0.2) translateY(0);
        animation: sparkle-pop 900ms cubic-bezier(0.2, 0.9, 0.3, 1) forwards;
      }
      .sparkles .spark.pink {
        background: linear-gradient(180deg, #fff0f8, #ffbed8);
        box-shadow: 0 0 8px rgba(255, 156, 178, 0.9),
          0 0 18px rgba(255, 156, 178, 0.28);
      }
      @keyframes sparkle-pop {
        0% {
          opacity: 0;
          transform: scale(0.2) translateY(6px);
        }
        20% {
          opacity: 1;
          transform: scale(1.05) translateY(-2px);
        }
        60% {
          opacity: 1;
          transform: scale(0.9) translateY(-8px);
        }
        100% {
          opacity: 0;
          transform: scale(0.6) translateY(-20px);
        }
      }

      /* confetti canvas */
      #confetti {
        position: fixed;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
        pointer-events: none;
        z-index: 1000;
      }

      /* toaster */
      .toast-container {
        position: fixed;
        left: 50%;
        transform: translateX(-50%);
        bottom: 20px;
        display: flex;
        flex-direction: column;
        gap: 10px;
        z-index: 2000;
        align-items: center;
      }
      .toast {
        min-width: 220px;
        max-width: 92vw;
        padding: 10px 14px;
        border-radius: 10px;
        color: #fff;
        font-weight: 600;
        box-shadow: 0 8px 30px rgba(0, 0, 0, 0.18);
        opacity: 0;
        transform: translateY(8px);
        display: flex;
        gap: 10px;
        align-items: center;
      }
      .toast.show {
        animation: toastIn 0.28s forwards;
      }
      @keyframes toastIn {
        to {
          opacity: 1;
          transform: translateY(0);
        }
      }
      .toast.success {
        background: linear-gradient(90deg, var(--toast-success), #2aa05a);
      }
      .toast.error {
        background: linear-gradient(90deg, var(--toast-error), #c03838);
      }
      .toast.info {
        background: linear-gradient(90deg, var(--toast-info), #2a74a8);
      }

      /* mobile tweaks to ensure countdown & title visible */
      @media (max-width: 560px) {
        .brand-text .title {
          font-size: 17px;
        }
        .brand-text .subtitle {
          font-size: 12px;
        }
        .count-pill {
          min-width: 48px;
          padding: 6px 8px;
        }
        .countdownTop {
          width: 100%;
          justify-content: flex-start;
        }
        .controls-right {
          width: 100%;
          justify-content: space-between;
        }
        .latest-supporter {
          min-width: 120px;
          padding: 6px 8px;
          font-size: 12px;
        }
        .team-score {
          font-size: 26px;
        }
        .choice .emoji {
          width: 52px;
          font-size: 34px;
        }
      }
      /* Ensure card is top-aligned on small screens so header never gets clipped */
      @media (max-width: 768px) {
        html,
        body {
          height: 100%;
        }
        body {
          /* stop vertical centering on mobile so top of card is visible */
          align-items: flex-start !important;
          justify-content: flex-start !important;
          padding-top: max(
            18px,
            env(safe-area-inset-top)
          ); /* respect notch / status bar */
          padding-left: 12px;
          padding-right: 12px;
          padding-bottom: 24px;
        }

        /* small spacing so card doesn't touch the top exactly */
        .wrap {
          margin-top: 6px;
        }

        /* Make sure header stacks and remains centered */
        .header {
          flex-direction: column;
          align-items: center;
          text-align: center;
        }
        .brand {
          flex-direction: column;
          align-items: center;
        }
      }
    </style>
  </head>

  <body>
    <div class="wrap">
      <div class="card" id="card">
        <div class="header">
          <div class="brand">
            <div class="crest">üëë</div>
            <div class="brand-text">
              <div class="title">Welcome Little One ‚Äî Cast Your Vote</div>
              <div class="subtitle">
                Aman & Akanksha ‚Äî Pick a side and bless the little one
              </div>
            </div>
          </div>

          <div class="controls-right">
            <div class="countdownTop" id="countdownTop" aria-hidden="false">
              <div
                style="
                  font-weight: 800;
                  color: var(--muted);
                  font-size: 13px;
                  margin-right: 6px;
                "
              >
                Reveal in
              </div>
              <div class="count-pill">
                <div class="num" id="cdDays">0</div>
                <div class="label">Days</div>
              </div>
              <div class="count-pill">
                <div class="num" id="cdHours">0</div>
                <div class="label">Hours</div>
              </div>
              <div class="count-pill">
                <div class="num" id="cdMins">0</div>
                <div class="label">Mins</div>
              </div>
              <div class="count-pill">
                <div class="num" id="cdSecs">0</div>
                <div class="label">Secs</div>
              </div>
            </div>

            <div
              id="latestSupporter"
              class="latest-supporter"
              aria-live="polite"
              title="Latest supporter"
            >
              Waiting for supporters...
            </div>
          </div>
        </div>

        <div class="teams-row" style="margin-top: 14px">
          <div id="teamBoyCard" class="team-card team-boy">
            <div class="team-name">Baby Boy Gang</div>
            <div class="team-score" id="boyCount">0</div>
            <div class="progress-wrap">
              <div class="progress-bg">
                <div id="boyFill" class="progress-fill" style="width: 0%"></div>
              </div>
              <div class="percent" id="boyPercent">0%</div>
            </div>
          </div>

          <div id="teamGirlCard" class="team-card team-girl">
            <div class="team-name">Baby Girl Gang</div>
            <div class="team-score" id="girlCount">0</div>
            <div class="progress-wrap">
              <div class="progress-bg">
                <div
                  id="girlFill"
                  class="progress-fill"
                  style="width: 0%"
                ></div>
              </div>
              <div class="percent" id="girlPercent">0%</div>
            </div>
          </div>
        </div>

        <div class="grid" style="margin-top: 18px">
          <div class="choices" aria-hidden="false">
            <div
              class="choice"
              id="boy"
              data-value="boy"
              role="button"
              tabindex="0"
              aria-pressed="false"
            >
              <div
                class="emoji"
                style="
                  background: linear-gradient(180deg, var(--boy-2), #d7e9ff);
                "
              >
                <span>ü§¥</span>
              </div>
              <div class="meta">
                <div class="titleSmall">Baby Boy Gang</div>
                <div class="desc">Predict a prince ‚Äî join the Boy Gang</div>
              </div>
            </div>

            <div
              class="choice"
              id="girl"
              data-value="girl"
              role="button"
              tabindex="0"
              aria-pressed="false"
            >
              <div
                class="emoji"
                style="
                  background: linear-gradient(180deg, var(--girl-2), #fff0f4);
                "
              >
                <span>üë∏</span>
              </div>
              <div class="meta">
                <div class="titleSmall">Baby Girl Gang</div>
                <div class="desc">Predict a princess ‚Äî join the Girl Gang</div>
              </div>
            </div>
          </div>

          <div class="panel" aria-hidden="false">
            <h3>Make your prediction</h3>
            <div class="muted">
              Reveal Date: <strong>14 November 2025</strong>
            </div>

            <div class="inputs" style="margin-top: 12px">
              <input
                id="name"
                placeholder="Your Name (required)"
                required
                aria-required="true"
              />
              <input
                id="relation"
                placeholder="Relation (required ‚Äî e.g., Papa, Masi)"
                required
                aria-required="true"
              />
            </div>

            <div class="cta" style="margin-top: 12px">
              <button class="btnMain" id="voteBtn" disabled>
                Submit Your Prediction
              </button>
              <button class="btnGhost" id="shareBtn">Share</button>
            </div>

            <div style="margin-top: 12px; font-size: 13px; color: var(--muted)">
              Tip: relation is required so we can personalize your thank-you.
            </div>
          </div>
        </div>

        <footer
          style="
            margin-top: 14px;
            text-align: center;
            color: var(--muted);
            font-size: 13px;
          "
        >
          With love, Aman & Akanksha
        </footer>
      </div>
    </div>

    <!-- modal -->
    <div
      class="modalWrap"
      id="modalWrap"
      role="dialog"
      aria-modal="true"
      aria-hidden="true"
    >
      <div
        class="modal"
        role="document"
        aria-labelledby="modalTitle"
        aria-describedby="modalMsg"
      >
        <h2 id="modalTitle">Thank you!</h2>
        <div id="modalMsg" class="modal-content">
          <p>We appreciate your prediction.</p>
        </div>
        <div class="sparkles" aria-hidden="true"></div>
        <div class="modal-actions">
          <button class="btnMain" id="modalClose">Close</button>
        </div>
      </div>
    </div>

    <!-- confetti -->
    <canvas id="confetti"></canvas>

    <!-- toaster container -->
    <div
      class="toast-container"
      id="toastContainer"
      aria-live="polite"
      aria-atomic="true"
    ></div>

    <script type="module">
      // ---------- CONFIG ----------
      const FORMSPREE_ENDPOINT = "https://formspree.io/f/xzzkjneo";

      import { initializeApp } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-app.js";
      import {
        getDatabase,
        ref,
        set,
        onValue,
        get,
      } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-database.js";
      import {
        getAuth,
        signInAnonymously,
        onAuthStateChanged,
      } from "https://www.gstatic.com/firebasejs/12.5.0/firebase-auth.js";

      // Firebase config (regional DB root)
      const firebaseConfig = {
        apiKey: "AIzaSyDJMam9PYVpprTjX-hSx4zqoqkp5AOEQaA",
        authDomain: "baby-prediction-2947c.firebaseapp.com",
        databaseURL:
          "https://baby-prediction-2947c-default-rtdb.asia-southeast1.firebasedatabase.app",
        projectId: "baby-prediction-2947c",
        storageBucket: "baby-prediction-2947c.firebasestorage.app",
        messagingSenderId: "746431850655",
        appId: "1:746431850655:web:2d3d4cddf4e7fa6e855aaa",
        measurementId: "G-Y4LQT2ZRD5",
      };

      const app = initializeApp(firebaseConfig);
      const db = getDatabase(app);
      const auth = getAuth(app);

      // UI refs
      const choices = Array.from(document.querySelectorAll(".choice"));
      const boyCountEl = document.getElementById("boyCount");
      const girlCountEl = document.getElementById("girlCount");
      const boyFill = document.getElementById("boyFill");
      const girlFill = document.getElementById("girlFill");
      const boyPercent = document.getElementById("boyPercent");
      const girlPercent = document.getElementById("girlPercent");
      const teamBoyCard = document.getElementById("teamBoyCard");
      const teamGirlCard = document.getElementById("teamGirlCard");

      const voteBtn = document.getElementById("voteBtn");
      const shareBtn = document.getElementById("shareBtn");
      const nameInput = document.getElementById("name");
      const relInput = document.getElementById("relation");

      const modalWrap = document.getElementById("modalWrap");
      const modalTitle = document.getElementById("modalTitle");
      const modalMsg = document.getElementById("modalMsg");
      const modalClose = document.getElementById("modalClose");
      const latestSupporterEl = document.getElementById("latestSupporter");

      const cdDays = document.getElementById("cdDays");
      const cdHours = document.getElementById("cdHours");
      const cdMins = document.getElementById("cdMins");
      const cdSecs = document.getElementById("cdSecs");

      const toastContainer = document.getElementById("toastContainer");

      const revealDate = new Date("2025-11-14T00:00:00");

      let myUid = null;
      let selectedValue = null;
      let authReady = false;
      let prevCounts = { boy: 0, girl: 0 };

      // ---------- TOASTER ----------
      function showToast(message, type = "info", timeout = 4000) {
        const id = "t_" + Math.random().toString(36).slice(2, 9);
        const div = document.createElement("div");
        div.className =
          "toast show " +
          (type === "success"
            ? "success"
            : type === "error"
            ? "error"
            : "info");
        div.id = id;
        div.setAttribute("role", "status");
        div.setAttribute("aria-live", "polite");
        div.innerHTML = `<span style="opacity:0.95; margin-right:8px;">${
          type === "success" ? "üéâ" : type === "error" ? "‚ö†Ô∏è" : "‚ÑπÔ∏è"
        }</span><div style="flex:1">${message}</div>`;
        toastContainer.appendChild(div);
        setTimeout(() => {
          div.classList.remove("show");
          try {
            div.style.opacity = "0";
          } catch {}
        }, timeout);
        // remove after animation
        setTimeout(() => {
          if (div && div.parentNode) div.parentNode.removeChild(div);
        }, timeout + 450);
      }

      // Handy replacements for previous alert usage
      function notifyMissingSelection() {
        showToast(
          "Please pick Baby Boy Gang or Baby Girl Gang before submitting.",
          "info",
          3500
        );
      }
      function notifyMissingRelation() {
        showToast(
          "Relation is required ‚Äî please enter it so we can say thank you properly.",
          "info",
          3500
        );
      }
      function notifyAuthPending() {
        showToast(
          "Still signing in ‚Äî give us a second and try again.",
          "info",
          3000
        );
      }
      function notifySaveError() {
        showToast(
          "Could not save vote. Please check your connection or try again later.",
          "error",
          4500
        );
      }
      function notifySaved() {
        showToast("Your prediction is saved ‚Äî thank you!", "success", 3000);
      }

      // ---------- helpers ----------
      function animateNumber(el, from, to, duration = 700) {
        from = Number(from) || 0;
        to = Number(to) || 0;
        if (!el) return;
        if (from === to) {
          el.textContent = String(to);
          return;
        }
        const start = performance.now();
        const step = (now) => {
          const t = Math.min(1, (now - start) / duration);
          const ease = 1 - (1 - t) * (1 - t);
          const cur = Math.round(from + (to - from) * ease);
          el.textContent = String(cur);
          if (t < 1) requestAnimationFrame(step);
        };
        requestAnimationFrame(step);
      }

      function timeAgo(isoString) {
        if (!isoString) return "";
        const then = new Date(isoString).getTime();
        if (isNaN(then)) return "";
        const now = Date.now();
        const diff = Math.floor((now - then) / 1000);
        if (diff < 6) return "just now";
        if (diff < 60) return diff + "s ago";
        if (diff < 3600) return Math.floor(diff / 60) + "m ago";
        if (diff < 86400) return Math.floor(diff / 3600) + "h ago";
        if (diff < 2592000) return Math.floor(diff / 86400) + "d ago";
        if (diff < 31536000) return Math.floor(diff / 2592000) + "mo ago";
        return Math.floor(diff / 31536000) + "y ago";
      }
      function formatExactLocal(isoString) {
        if (!isoString) return "";
        const d = new Date(isoString);
        try {
          return d.toLocaleString("en-IN", {
            timeZone: "Asia/Kolkata",
            year: "numeric",
            month: "short",
            day: "numeric",
            hour: "2-digit",
            minute: "2-digit",
          });
        } catch (e) {
          return d.toString();
        }
      }

      // ---------- auth ----------
      async function startAuth() {
        try {
          await signInAnonymously(auth);
          console.log("Anonymous sign-in requested");
        } catch (e) {
          console.error("startAuth error", e);
          showToast(
            "Could not sign in anonymously. Check Firebase config.",
            "error",
            5000
          );
        }
      }
      startAuth();

      // ---------- realtime listeners ----------
      function attachRealtimeListener() {
        if (window._votesListenerAttached) return;
        window._votesListenerAttached = true;
        const votesRef = ref(db, "votes");
        onValue(
          votesRef,
          (snap) => {
            const data = snap.val() || {};
            let boy = 0,
              girl = 0;
            for (const uid in data) {
              const v = data[uid] && data[uid].vote;
              if (v === "boy") boy++;
              if (v === "girl") girl++;
            }

            animateNumber(boyCountEl, prevCounts.boy, boy);
            animateNumber(girlCountEl, prevCounts.girl, girl);

            const total = boy + girl || 0;
            let boyP = 0,
              girlP = 0;
            if (total > 0) {
              boyP = Math.round((boy / total) * 100);
              girlP = 100 - boyP;
            }

            if (boyFill) boyFill.style.width = boyP + "%";
            if (girlFill) girlFill.style.width = girlP + "%";
            animateNumber(
              boyPercent,
              parseInt(boyPercent.textContent || 0),
              boyP
            );
            animateNumber(
              girlPercent,
              parseInt(girlPercent.textContent || 0),
              girlP
            );

            teamBoyCard.classList.toggle("leader", boy > girl);
            teamGirlCard.classList.toggle("leader", girl > boy);

            if (myUid && data[myUid]) {
              selectedValue = data[myUid].vote;
              choices.forEach((c) =>
                c.classList.toggle(
                  "selected",
                  c.dataset.value === selectedValue
                )
              );
            }

            prevCounts.boy = boy;
            prevCounts.girl = girl;
          },
          (err) => {
            console.error("Realtime listener error (votes):", err);
            showToast(
              "Realtime listener error ‚Äî check database rules.",
              "error",
              4000
            );
          }
        );

        const lastRef = ref(db, "lastVote");
        onValue(
          lastRef,
          (snap) => {
            const val = snap.val();
            if (!val) {
              latestSupporterEl.textContent = "Waiting for supporters...";
              latestSupporterEl.title = "No supporters yet";
              return;
            }
            const nm = (val.name || "").trim();
            const rel = (val.relation || "").trim();
            const displayName =
              nm && rel ? `${nm} (${rel})` : nm || rel || "Friend";
            const heart =
              val.vote === "boy" ? "üíô" : val.vote === "girl" ? "üíñ" : "‚ù§Ô∏è";
            const gang =
              val.vote === "boy" ? "Baby Boy Gang" : "Baby Girl Gang";
            const prettyAgo = timeAgo(val.time);
            const exact = formatExactLocal(val.time);
            latestSupporterEl.textContent = `Last Vote: ${displayName} ‚Äî ${gang} ${heart}${
              prettyAgo ? " ¬∑ " + prettyAgo : ""
            }`;
            latestSupporterEl.title = `${displayName} ‚Äî ${gang} (${exact})`;
          },
          (err) => {
            console.error("Realtime listener error (lastVote):", err);
          }
        );
      }

      onAuthStateChanged(auth, (user) => {
        if (user) {
          myUid = user.uid;
          authReady = true;
          console.log("Signed in anonymously as", myUid);
          attachRealtimeListener();
          updateVoteButtonState();
        } else {
          myUid = null;
          authReady = false;
          startAuth();
          updateVoteButtonState();
        }
      });

      // ---------- confetti ----------
      const confCanvas = document.getElementById("confetti");
      const ctx = confCanvas.getContext && confCanvas.getContext("2d");
      let confettiParticles = [],
        confAnim = false;
      function resizeCanvas() {
        if (!ctx) return;
        confCanvas.width = window.innerWidth;
        confCanvas.height = window.innerHeight;
      }
      window.addEventListener("resize", resizeCanvas);
      resizeCanvas();

      function launchConfetti() {
        if (!ctx) return;
        for (let i = 0; i < 80; i++) {
          confettiParticles.push({
            x: Math.random() * confCanvas.width,
            y: -Math.random() * confCanvas.height * 0.5,
            w: 6 + Math.random() * 8,
            h: 8 + Math.random() * 10,
            vx: (Math.random() - 0.5) * 6,
            vy: 2 + Math.random() * 4,
            rot: Math.random() * 360,
            vr: (Math.random() - 0.5) * 8,
            color: ["#d4af37", "#f9e6b0", "#ffd37a"][
              Math.floor(Math.random() * 3)
            ],
          });
        }
        if (!confAnim) animateConfetti();
      }
      function animateConfetti() {
        confAnim = true;
        ctx.clearRect(0, 0, confCanvas.width, confCanvas.height);
        for (let i = confettiParticles.length - 1; i >= 0; i--) {
          const p = confettiParticles[i];
          p.x += p.vx;
          p.y += p.vy;
          p.vy += 0.06;
          p.rot += p.vr;
          ctx.save();
          ctx.translate(p.x, p.y);
          ctx.rotate((p.rot * Math.PI) / 180);
          ctx.fillStyle = p.color;
          ctx.fillRect(-p.w / 2, -p.h / 2, p.w, p.h);
          ctx.restore();
          if (p.y > confCanvas.height + 80) confettiParticles.splice(i, 1);
        }
        if (confettiParticles.length) requestAnimationFrame(animateConfetti);
        else {
          confAnim = false;
          ctx.clearRect(0, 0, confCanvas.width, confCanvas.height);
        }
      }

      // sparkles inside modal
      function createSparkles(count = 8, duration = 900) {
        let container = modalWrap.querySelector(".sparkles");
        if (!container) {
          container = document.createElement("div");
          container.className = "sparkles";
          const modalEl = modalWrap.querySelector(".modal");
          if (modalEl) modalEl.appendChild(container);
        }
        for (let i = 0; i < count; i++) {
          const s = document.createElement("span");
          s.className = "spark" + (Math.random() > 0.5 ? " pink" : "");
          const left = 8 + Math.random() * 84;
          const top = 18 + Math.random() * 60;
          s.style.left = left + "%";
          s.style.top = top + "%";
          const delay = Math.random() * 220;
          s.style.animationDelay = delay + "ms";
          container.appendChild(s);
          setTimeout(() => {
            if (s && s.parentNode) s.parentNode.removeChild(s);
          }, duration + delay + 80);
        }
        setTimeout(() => {
          const cur = modalWrap.querySelector(".sparkles");
          if (cur && cur.childElementCount === 0)
            cur.parentNode && cur.parentNode.removeChild(cur);
        }, duration + 700);
      }

      // modal helpers
      function openModalContent(titleText, htmlMessage) {
        modalTitle.textContent = titleText;
        modalMsg.innerHTML = htmlMessage;
        modalWrap.setAttribute("aria-hidden", "false");
        modalWrap.style.display = "flex";
        setTimeout(() => modalClose.focus(), 40);
      }
      function closeModalSafe() {
        if (document.activeElement) document.activeElement.blur();
        modalWrap.style.display = "none";
        modalWrap.setAttribute("aria-hidden", "true");
      }

      function showThankYou(voterDisplayName, vote) {
        const heart = vote === "boy" ? "üíô" : "üíñ";
        const lines = [
          "Your blessings mean the world to us ‚Äî thank you for being part of our joy!",
          "Your good wishes wrap this little one in love already.",
          "We can feel the love ‚Äî thank you for celebrating with us!",
          "Your kind prediction brings a smile to our hearts ‚Äî thank you!",
          "Thank you for the warm wishes ‚Äî we can‚Äôt wait to share the joy with you.",
          "Your excitement makes this moment even more magical ‚Äî thank you!",
        ];
        const voteLine =
          vote === "boy"
            ? "You believe a little <strong>Prince ü§¥</strong> is on his way ‚Äî may his laughter fill our home with joy!"
            : "You believe a little <strong>Princess üë∏</strong> is coming ‚Äî may her smile bring endless sunshine!";
        const randomLine = lines[Math.floor(Math.random() * lines.length)];
        const titleText = `Thank you, ${voterDisplayName} ${heart}`;
        const html = `<span class="msg-shimmer" aria-hidden="true"></span><div class="modal-content-inner"><div style="margin-bottom:8px;font-weight:600;color:#2b1f14">${randomLine}</div><div style="font-size:14px;color:#5b4b3a">${voteLine}</div><div style="margin-top:10px;font-size:13px;color:var(--muted)">Click <strong>Close</strong> when you're ready.</div></div>`;
        openModalContent(titleText, html);
        createSparkles(12, 950);
        launchConfetti();
      }

      // vote button enabling logic: only require relation + authReady
      function updateVoteButtonState() {
        const nameFilled = (nameInput.value || "").trim().length > 0;
        const relFilled = (relInput.value || "").trim().length > 0;
        const selectionMade = !!selectedValue; // check if user picked boy/girl
        voteBtn.disabled = !(
          authReady &&
          nameFilled &&
          relFilled &&
          selectionMade
        );
        voteBtn.style.opacity = voteBtn.disabled ? 0.55 : 1;
      }

      // submit vote
      function setVoteButtonState(isWorking) {
        if (!voteBtn) return;
        voteBtn.disabled = !!isWorking;
        voteBtn.style.opacity = isWorking ? 0.55 : 1;
        voteBtn.textContent = isWorking
          ? "Submitting..."
          : "Submit Your Prediction";
      }

      async function submitVote(voteValue) {
        if (!authReady || !myUid) {
          notifyAuthPending();
          return;
        }
        setVoteButtonState(true);
        let previousVote = "";
        try {
          const snap = await get(ref(db, `votes/${myUid}`));
          if (snap.exists()) {
            const prev = snap.val();
            previousVote = prev && prev.vote ? prev.vote : "";
          }
        } catch (e) {
          console.warn("read prev err", e);
        }
        const payload = {
          vote: voteValue,
          name: (nameInput.value || "").trim(),
          relation: (relInput.value || "").trim(),
          time: new Date().toISOString(),
        };
        try {
          await set(ref(db, `votes/${myUid}`), payload);
          await set(
            ref(db, `lastVote`),
            Object.assign({ uid: myUid }, payload)
          );
          notifySaved();
        } catch (e) {
          console.error("Firebase write failed", e);
          notifySaveError();
          setVoteButtonState(false);
          return;
        }

        // Formspree (fire-and-forget)
        try {
          const body = {
            event: "vote",
            previous_vote: previousVote || "",
            new_vote: voteValue,
            name: payload.name,
            relation: payload.relation,
            time: payload.time,
          };
          fetch(FORMSPREE_ENDPOINT, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify(body),
          })
            .then((r) => console.log("Formspree status", r.status))
            .catch((e) => console.warn("Formspree failed", e));
        } catch (e) {
          console.warn("Formspree error", e);
        }

        setVoteButtonState(false);
      }

      // UI handlers
      choices.forEach((c, i) => {
        c.addEventListener("click", () => {
          choices.forEach((x) => x.classList.remove("selected"));
          c.classList.add("selected");
          selectedValue = c.dataset.value;
          updateVoteButtonState();
        });
        c.addEventListener("keydown", (e) => {
          if (e.key === "Enter" || e.key === " ") {
            e.preventDefault();
            c.click();
          }
          if (e.key === "ArrowDown" || e.key === "ArrowRight")
            choices[(i + 1) % choices.length].focus();
          if (e.key === "ArrowUp" || e.key === "ArrowLeft")
            choices[(i - 1 + choices.length) % choices.length].focus();
        });
      });

      nameInput.addEventListener("input", updateVoteButtonState);
      relInput.addEventListener("input", updateVoteButtonState);

      voteBtn.addEventListener("click", async () => {
        if (!selectedValue) {
          notifyMissingSelection();
          return;
        }
        if (!(relInput.value || "").trim()) {
          notifyMissingRelation();
          relInput.focus();
          return;
        }
        if (!(nameInput.value || "").trim()) {
          showToast("Please enter your name (required).", "info", 3500);
          nameInput.focus();
          return;
        }
        await submitVote(selectedValue);
        const nm = (nameInput.value || "").trim(),
          rel = (relInput.value || "").trim();
        const who = nm
          ? `${nm}${rel ? " (" + rel + ")" : ""}`
          : rel
          ? rel
          : "Friend";
        showThankYou(who, selectedValue);
      });

      shareBtn.addEventListener("click", () => {
        const txt = encodeURIComponent(
          `Join Aman & Akanksha‚Äôs Baby ‚Äî Cast your prediction: ${location.href}`
        );
        if (navigator.share)
          navigator
            .share({
              title: "Welcome Little One ‚Äî Cast Your Vote",
              text: "Make your prediction!",
              url: location.href,
            })
            .catch(() => {});
        else window.open("https://wa.me/?text=" + txt, "_blank");
      });

      modalClose.addEventListener("click", () => closeModalSafe());
      modalWrap.addEventListener("click", (e) => {
        if (e.target === modalWrap) closeModalSafe();
      });

      // countdown (keeps visible on mobile; pills stack/scale via CSS)
      function updateCountdown() {
        const now = new Date();
        const diff = revealDate.getTime() - now.getTime();
        if (diff <= 0) {
          cdDays.textContent = "0";
          cdHours.textContent = "0";
          cdMins.textContent = "0";
          cdSecs.textContent = "0";
          return;
        }
        const days = Math.floor(diff / (1000 * 60 * 60 * 24));
        const hours = Math.floor(
          (diff % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60)
        );
        const mins = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
        const secs = Math.floor((diff % (1000 * 60)) / 1000);
        cdDays.textContent = days;
        cdHours.textContent = hours;
        cdMins.textContent = mins;
        cdSecs.textContent = secs;
      }
      updateCountdown();
      setInterval(updateCountdown, 1000);

      // initial console note
      console.log(
        "Page initialized ‚Äî waiting for Firebase auth & realtime updates."
      );
    </script>
  </body>
</html>
